# Factor Update Model - 配置迁移报告

迁移时间：2026-01-17
目标：使 `factor_update_model` 完全独立于 `Data_update` 项目

---

## 迁移总结

已成功将 `Data_update` 项目中所有与 factor 相关的配置文件迁移到 `factor_update_model`，使其能够完全独立部署到生产环境。

---

## 配置文件迁移清单

### 1. config_path/ 目录

**创建目录**：`factor_update_model/config_path/`

**迁移文件**：
- ✅ `data_update_path_config.xlsx` - 路径配置文件
  - 来源：`Data_update/config_path/data_update_path_config.xlsx`
  - 修改：去掉了 `Data_update\` 路径前缀，简化配置结构
  - 修改：删除了 Score 和 L4 相关配置（27行），保留 88 行 factor 相关配置

### 2. config_project/ 目录

**迁移文件列表**：

| 文件名 | 用途 | 来源 |
|--------|------|------|
| `sql_connection.yaml` | MySQL数据库连接配置 | `Data_update/config_project/Data_update/` |
| `data_source_priority_config.xlsx` | 数据源优先级配置（包含factor sheet） | `Data_update/config_project/Data_update/` |
| `time_tools_config.xlsx` | 时间工具配置 | `Data_update/config_project/Data_update/` |
| `dataUpdate_sql.yaml` | 数据库表配置（包含factor表定义） | `Data_update/config_project/Data_update/` |
| `dataUpdate_sql_ori.yaml` | 原始数据库表配置（备份） | `Data_update/config_project/Data_update/` |
| `database_check.yaml` | 数据库表检查配置 | `Data_update/config_project/Data_update/` |
| `rename_mapping_wind.yaml` | Wind数据重命名映射 | `Data_update/config_project/Data_update/` |

**已有文件**：
- `MySQL数据库表结构.md` - 数据库表结构文档
- `配置文件说明.md` - 配置文件详细说明
- `sql_connection.yaml.example` - SQL连接配置示例
- `l4_connection.yaml.example` - L4连接配置示例
- `L4_config/` - L4数据库配置目录

---

## 配置路径调整

### 修改前（引用父项目）
```
data_source_priority: config_project/Data_update/data_source_priority_config.xlsx
time_tools_config: config_project/Data_update/time_tools_config.xlsx
config_sql: config_project/Data_update/dataUpdate_sql.yaml
```

### 修改后（完全独立）
```
data_source_priority: config_project/data_source_priority_config.xlsx
time_tools_config: config_project/time_tools_config.xlsx
config_sql: config_project/dataUpdate_sql.yaml
```

---

## 删除的配置项

为使 `factor_update_model` 专注于因子数据更新，删除了以下无关配置：

### Score 相关配置（4项）
- `score_mode` - 评分模式配置
- `mode_dic` - 模式字典
- `output_portfolio_info` - 组合信息输出
- `output_portfolio_info_bu` - 组合信息备份输出
- `input_score` - 评分数据输入
- `output_score` - 评分数据输出
- `output_portfolio` - 组合权重输出
- `output_indexScore` - 指数评分差异输出

### L4 相关配置（19项）
- `L4_config` - L4配置文件
- `outputpath_RR500` 等产品持仓数据路径（8项）
- `outputpath1_RR500` 等产品信息数据路径（8项）
- `manual` - 手工数据路径
- `output_l4` - L4数据输出路径

**总计删除**：27 行配置
**保留配置**：88 行 factor 及基础数据相关配置

---

## 配置验证结果

所有 factor 相关配置均可正确读取：

✅ **核心配置**
- `data_source_priority` - 数据源优先级配置
- `time_tools_config` - 时间工具配置
- `config_sql` - SQL配置

✅ **Factor 输出路径**
- `output_factor_exposure` - 因子暴露度输出
- `output_factor_return` - 因子收益率输出
- `output_factor_stockpool` - 因子股票池输出
- `output_factor_cov` - 因子协方差输出
- `output_factor_specific_risk` - 因子特异性风险输出

✅ **Factor 输入路径**
- `input_factor_wind` - Wind因子数据输入
- `input_factor_jy` - 聚源因子数据输入

✅ **时间序列**
- `output_timeseries` - 时间序列数据输出

**验证结果**：11/11 配置项全部通过 ✅

---

## ⚠️ 重要提醒：敏感信息检查

### 需要检查和更新的配置文件

#### 1. sql_connection.yaml
**当前状态**：包含数据库凭证
```yaml
database:
  host: rm-bp1o6we7s3o1h76x1to.mysql.rds.aliyuncs.com
  port: 3306
  database: data_prepared_new
  user: wc
  password: Abcd1234#
```

**建议操作**：
- [ ] 验证数据库凭证是否为生产环境凭证
- [ ] 确认数据库地址和端口是否正确
- [ ] 如需修改，编辑 `factor_update_model/config_project/sql_connection.yaml`

#### 2. dataUpdate_sql.yaml
**当前状态**：包含多个数据库表的连接字符串（硬编码密码）

**示例**：
```yaml
FactorExposrue:
    table_name: "data_factorexposure"
    db_url: "mysql+pymysql://prod:Abcd1234#@rm-bp1o6we7s3o1h76x1to.mysql.rds.aliyuncs.com:3306/data_prepared_new?autocommit=True "
```

**建议操作**：
- [ ] 检查数据库凭证是否正确
- [ ] 如需修改，编辑 `factor_update_model/config_project/dataUpdate_sql.yaml`

---

## 独立部署检查清单

### 配置文件
- [x] 复制所有必需的配置文件
- [x] 调整配置文件路径（去掉 Data_update\ 前缀）
- [x] 删除无关配置（Score、L4）
- [ ] **检查并更新数据库凭证**
- [x] 验证配置文件可正确读取

### 代码修复
- [x] 修复安全问题（L4_config 硬编码密码）
- [x] 添加环境变量检查（所有子模块）
- [x] 修复代码重复导入问题
- [x] 补充依赖包（SQLAlchemy）

### 部署准备
- [ ] 设置环境变量 `GLOBAL_TOOLSFUNC_new`
- [ ] 验证数据源文件路径是否存在
- [ ] 验证输出目录是否存在
- [ ] 配置 Windows 任务计划程序

---

## 文件结构对比

### 迁移前（依赖父项目）
```
Data_update/
├── config_path/
│   └── data_update_path_config.xlsx
├── config_project/
│   └── Data_update/
│       ├── sql_connection.yaml
│       ├── data_source_priority_config.xlsx
│       ├── time_tools_config.xlsx
│       └── ...
└── factor_update_model/
    ├── factor_update_main.py
    ├── FactorData_update/
    └── ...
```

### 迁移后（完全独立）
```
factor_update_model/
├── config_path/
│   └── data_update_path_config.xlsx  ✨ 新增（去掉Score/L4配置）
├── config_project/
│   ├── sql_connection.yaml            ✨ 新增
│   ├── data_source_priority_config.xlsx  ✨ 新增
│   ├── time_tools_config.xlsx         ✨ 新增
│   ├── dataUpdate_sql.yaml            ✨ 新增
│   ├── database_check.yaml            ✨ 新增
│   ├── rename_mapping_wind.yaml       ✨ 新增
│   ├── MySQL数据库表结构.md
│   ├── 配置文件说明.md
│   ├── sql_connection.yaml.example
│   ├── l4_connection.yaml.example
│   └── L4_config/
├── factor_update_main.py
├── FactorData_update/
├── TimeSeries_update/
├── Time_tools/
├── global_setting/
└── ...
```

---

## 下一步操作建议

### 生产环境部署前

1. **检查数据库凭证**
   ```bash
   # 编辑配置文件
   notepad factor_update_model\config_project\sql_connection.yaml
   notepad factor_update_model\config_project\dataUpdate_sql.yaml
   ```

2. **设置环境变量**
   ```cmd
   # Windows系统级环境变量
   setx GLOBAL_TOOLSFUNC_new "D:\path\to\global_tools" /M
   ```

3. **验证数据路径**
   - 检查 `data_update_path_config.xlsx` 中的输入/输出路径
   - 确认数据源目录存在
   - 确认输出目录有写入权限

4. **测试运行**
   ```bash
   cd factor_update_model
   python factor_update_main.py
   ```

5. **配置任务计划程序**
   - 设置定时执行时间
   - 配置日志输出路径
   - 设置失败重试策略

---

## 总结

✅ **配置迁移完成**
- 所有 factor 相关配置已成功迁移
- 路径结构已简化（去掉 Data_update\ 前缀）
- 无关配置已清理（Score、L4）

✅ **代码问题修复**
- 安全问题已修复
- 环境变量检查已添加
- 代码质量问题已修复

⚠️ **需要用户操作**
- 检查和更新数据库凭证
- 设置环境变量
- 验证数据路径
- 配置任务计划程序

**factor_update_model 现已完全独立，可以单独部署到生产环境！**
