# 配置文件说明

本文档说明项目部署时需要配置的所有文件。

## 配置文件清单

| 文件 | 用途 | 是否必须 |
|------|------|----------|
| `config_project/sql_connection.yaml` | 输出数据库连接 | 是 (如需写入数据库) |
| `config_project/dataUpdate_sql.yaml` | 数据表结构定义 | 是 (如需写入数据库) |
| `config_project/l4_connection.yaml` | L4输入数据库连接 | 是 (如需从L4读取数据) |
| `config_path/data_update_path_config.xlsx` | 数据路径配置 | 是 |

## 1. sql_connection.yaml (输出数据库连接)

用于配置因子数据输出目标数据库。

**配置步骤:**
```bash
cd config_project
cp sql_connection.yaml.example sql_connection.yaml
# 编辑 sql_connection.yaml，填入实际的数据库连接信息
```

**配置示例:**
```yaml
database:
  host: rm-xxx.mysql.rds.aliyuncs.com   # 数据库主机
  port: 3306                             # 端口
  user: your_username                    # 用户名
  password: your_password                # 密码
  database: data_prepared_new            # 数据库名
```

## 2. dataUpdate_sql.yaml (数据表结构定义)

定义各类数据表的结构、主键和写入配置。

**配置步骤:**
```bash
cd config_project
cp dataUpdate_sql.yaml.example dataUpdate_sql.yaml
# 编辑 dataUpdate_sql.yaml，替换所有 db_url 中的连接信息
```

**关键配置项:**
- `db_url`: SQLAlchemy 连接字符串
- `table_name`: 目标表名
- `private_keys`: 主键字段 (用于 upsert)
- `schema`: 表结构定义

**db_url 格式:**
```
mysql+pymysql://用户名:密码@主机地址:端口/数据库名?autocommit=True
```

**需要配置的表:**

### 因子数据表
| 配置键 | 表名 | 说明 |
|--------|------|------|
| FactorExposrue | data_factorexposure | 因子暴露度 |
| FactorReturn | data_factorreturn | 因子收益率 |
| FactorPool | data_factorpool | 因子股票池 |
| FactorCov | data_factorcov | 因子协方差 |
| FactorSpecificrisk | data_factorspecificrisk | 特异性风险 |
| FactorIndexExposure | data_factorindexexposure | 指数因子暴露 |

### 行情数据表
| 配置键 | 表名 | 说明 |
|--------|------|------|
| indexData | data_index | 指数行情 |
| indexComponent | data_indexcomponent | 指数成分 |
| stockData | data_stock | 股票行情 |
| futureData | data_future | 期货行情 |
| optionData | data_option | 期权行情 |
| etfData | data_etf | ETF行情 |

## 3. l4_connection.yaml (L4输入数据库连接)

用于配置从 L4 系统读取数据的数据库连接。

**配置步骤:**
```bash
cd config_project
cp l4_connection.yaml.example l4_connection.yaml
# 编辑 l4_connection.yaml，填入实际的数据库连接信息
```

**配置示例:**
```yaml
data_prepared_new:
  host: your_host_here
  port: 3306
  user: your_username
  password: your_password
  database: data_prepared_new

rz_hfdb_core:
  host: your_host_here
  port: 3306
  user: your_username
  password: your_password
  database: rz_hfdb_core
```

## 4. data_update_path_config.xlsx (数据路径配置)

配置输入输出数据的文件路径。

**文件位置:** `config_path/data_update_path_config.xlsx`

**主要配置项:**
| 路径名 | 说明 |
|--------|------|
| input_factor_jy | JY因子数据输入路径 |
| input_factor_wind | Wind因子数据输入路径 |
| input_factor_cov_jy | JY协方差数据输入路径 |
| input_factor_specific_jy | JY特异性风险输入路径 |
| output_factor_exposure | 因子暴露度输出路径 |
| output_factor_return | 因子收益率输出路径 |
| output_factor_cov | 协方差输出路径 |
| data_other | 其他数据路径 (股票池等) |

## 快速配置脚本

可以使用以下脚本快速创建配置文件:

```bash
cd config_project

# 复制所有 example 文件
for f in *.example; do
    cp "$f" "${f%.example}"
done

echo "请编辑以下文件，填入实际的数据库连接信息:"
echo "  - sql_connection.yaml"
echo "  - dataUpdate_sql.yaml"
echo "  - l4_connection.yaml"
```

## 环境变量

除了配置文件，还需要设置环境变量:

```bash
# 设置 global_tools 路径 (必须)
export GLOBAL_TOOLSFUNC_new=/path/to/global_tools

# Windows 系统
set GLOBAL_TOOLSFUNC_new=D:\path\to\global_tools
```

## 安全提醒

1. **不要提交真实凭据**: 所有 `.yaml` 文件 (除 `.example`) 已在 `.gitignore` 中
2. **定期更换密码**: 建议定期更新数据库密码
3. **最小权限原则**: 为应用创建专用数据库账户，仅授予必要权限

## 验证配置

配置完成后，可以运行测试验证:

```bash
# 安装依赖
pip install -r requirements.txt

# 运行测试
pytest tests/ -v -m unit
```
