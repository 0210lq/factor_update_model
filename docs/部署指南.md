# 部署指南

本文档说明如何在新环境中独立部署 factor_update_model 项目。

## 一、环境要求

### 1. Python 环境
- Python 3.8+
- 推荐使用虚拟环境

### 2. 系统依赖
- Windows / Linux / macOS
- 网络访问（如需连接远程数据库）

---

## 二、部署步骤

### 步骤 1：克隆项目

```bash
git clone <repository_url>
cd factor_update_model
```

### 步骤 2：安装依赖

```bash
pip install -r requirements.txt
```

依赖包列表：
- pandas >= 2.0.0
- numpy >= 1.20.0
- scipy >= 1.10.0
- PyMySQL >= 1.0.0
- PyYAML >= 6.0
- openpyxl >= 3.0.0
- xlrd >= 2.0.0
- python-dateutil >= 2.8.0

### 步骤 3：设置环境变量

项目依赖外部模块 `global_tools`，需要设置环境变量指向该模块路径。

**Windows (CMD):**
```cmd
set GLOBAL_TOOLSFUNC_new=D:\path\to\global_tools
```

**Windows (PowerShell):**
```powershell
$env:GLOBAL_TOOLSFUNC_new = "D:\path\to\global_tools"
```

**Linux/macOS:**
```bash
export GLOBAL_TOOLSFUNC_new=/path/to/global_tools
```

**永久设置 (推荐):**
- Windows: 系统属性 → 高级 → 环境变量
- Linux: 添加到 `~/.bashrc` 或 `~/.profile`

### 步骤 4：配置数据库连接

1. 复制示例配置文件：
```bash
cp config_project/sql_connection.yaml.example config_project/sql_connection.yaml
```

2. 编辑 `sql_connection.yaml`，填入实际的数据库连接信息：
```yaml
database:
  host: your_host
  port: 3306
  user: your_username
  password: your_password
  database: your_database
```

### 步骤 5：配置数据路径

编辑 `config_path/data_update_path_config.xlsx`，配置以下路径：

| 配置项 | 说明 | 示例 |
|--------|------|------|
| input_factor_jy | JY因子数据目录 | D:\Data\jy\FactorRet |
| input_factor_wind | Wind因子数据目录 | D:\Data\wind\FactorRet |
| output_factor_exposure | 因子暴露度输出目录 | D:\Output\exposure |
| data_other | 股票池等辅助数据 | D:\Data\other |

详细配置项参见 `config_project/配置文件说明.md`

### 步骤 6：准备数据文件

确保以下数据文件存在：

1. **因子数据** (.mat 文件)
   - 路径: `input_factor_jy/LNMODELACTIVE-YYYYMMDD.mat`
   - 路径: `input_factor_wind/LNMODELACTIVE-YYYYMMDD.mat`

2. **协方差数据** (.csv 文件)
   - 路径: `input_factor_cov_jy/CovarianceMatrix_YYYYMMDD.csv`

3. **特异性风险数据** (.csv 文件)
   - 路径: `input_factor_specific_jy/SpecificRisk_YYYYMMDD.csv`

4. **股票池数据**
   - 路径: `data_other/StockUniverse_new.csv`

5. **指数成分股数据**
   - 路径: `output_indexcomponent/{index}/` 下的 CSV 文件

详细数据格式参见 `docs/数据需求清单.md`

---

## 三、验证部署

### 1. 导入测试

```bash
python test_import.py
```

预期输出：所有模块导入成功

### 2. 测试数据验证 (可选)

生成测试数据并运行验证：

```bash
python scripts/generate_test_data.py
python scripts/run_test.py
```

预期输出：5/5 测试通过

---

## 四、运行项目

### 日常更新

```python
from factor_update_main import FactorData_update_main

# 自动计算日期，更新最近数据
FactorData_update_main(is_sql=True)
```

### 历史数据更新

```python
from factor_update_main import FactorData_history_update

# 更新指定日期范围
FactorData_history_update(
    start_date='2024-01-01',
    end_date='2024-12-31',
    is_sql=True,
    include_timeseries=True
)
```

### 命令行运行

```bash
python factor_update_main.py
```

---

## 五、目录结构

```
factor_update_model/
├── factor_update_main.py       # 主入口
├── requirements.txt            # 依赖清单
├── test_import.py              # 导入测试
│
├── FactorData_update/          # 因子更新核心模块
├── TimeSeries_update/          # 时间序列更新模块
├── Time_tools/                 # 时间工具模块
├── global_setting/             # 全局配置
├── setup_logger/               # 日志模块
│
├── config_project/             # 配置文件目录
│   ├── sql_connection.yaml     # 数据库连接 (需创建)
│   ├── data_source_priority_config.xlsx
│   └── time_tools_config.xlsx
│
├── config_path/                # 路径配置
│   └── data_update_path_config.xlsx
│
├── logs/                       # 日志输出 (自动创建)
├── docs/                       # 文档
└── scripts/                    # 脚本工具
```

---

## 六、常见问题

### Q1: 环境变量未设置
```
EnvironmentError: 环境变量 GLOBAL_TOOLSFUNC_new 未设置
```
**解决**: 按步骤 3 设置环境变量

### Q2: 找不到配置文件
```
FileNotFoundError: 未找到数据库配置文件
```
**解决**: 按步骤 4 创建 sql_connection.yaml

### Q3: 数据文件缺失
```
WARNING: factor_data在20250120数据存在缺失
```
**解决**: 确保数据源目录下有对应日期的文件

### Q4: 数据库连接失败
```
pymysql.err.OperationalError: Can't connect to MySQL server
```
**解决**: 检查数据库配置和网络连接

---

## 七、注意事项

1. **敏感信息**: `sql_connection.yaml` 包含数据库密码，请勿提交到 git
2. **数据备份**: 运行前建议备份输出目录
3. **日志检查**: 运行后检查 `logs/` 目录下的日志文件
4. **SQL 模式**: 如不需写入数据库，可设置 `is_sql=False`

---

*文档版本: 1.0*
*更新日期: 2026-01-25*
